import gzip
from dataclasses import dataclass
from typing import cast

from insta_wizard.common.generators import (
    current_timestamp_ms,
    generate_uuid_v4_string,
)
from insta_wizard.mobile.commands._responses.feed.feed_injected_reels_media import (
    FeedInjectedReelsMediaResponse,
)
from insta_wizard.mobile.common import constants
from insta_wizard.mobile.common.command import (
    Command,
    CommandHandler,
)
from insta_wizard.mobile.common.requesters.api_requester import (
    ApiRequestExecutor,
)
from insta_wizard.mobile.common.utils import build_signed_body
from insta_wizard.mobile.models.state import (
    MobileClientState,
)


@dataclass(slots=True)
class FeedInjectedReelsMedia(Command[FeedInjectedReelsMediaResponse]):
    pass


TRAY_USER_IDS = [
    "4263859518",
    "67697508577",
    "64776963713",
    "3497714510",
    "181403753",
    "1538036112",
    "1727357981",
    "7210969523",
    "8173105297",
    "26564517793",
    "1289286502",
    "47678821853",
    "54317291503",
    "8201088492",
    "4541274901",
    "19978768704",
    "1491289929",
    "16097062",
    "61451570881",
    "49858156776",
    "50694735719",
    "2076950474",
    "61238184713",
    "270075132",
    "48401162912",
    "48903523637",
    "51403156044",
    "48073972154",
    "44187154693",
    "2001322713",
    "25707649255",
    "56671247996",
    "44176814630",
    "65456672099",
    "45485980480",
    "1539372892",
    "30495427",
    "34868778349",
    "44530901818",
    "4976792623",
    "2325751068",
    "44528813038",
    "5820159345",
    "30109797",
    "38902754",
    "64751068183",
    "30086311348",
    "2685309700",
    "60538971992",
    "3284915195",
    "4810064195",
    "21459335533",
    "55057895145",
    "3257299",
    "1585739799",
    "43586820065",
    "48657472317",
    "58752056547",
    "16104906222",
    "49071564381",
    "51795275335",
    "47706480045",
    "71073373538",
    "63290153052",
    "1518581294",
    "46152006203",
    "16706442481",
    "55788839181",
    "2370291410",
    "46295429913",
    "50210614710",
    "21976029772",
    "3966267013",
    "1546101748",
    "12575702157",
    "44912132796",
    "25477487802",
    "54255381572",
    "55202968597",
    "47482526223",
    "5723529025",
    "50347464211",
    "47397369171",
    "4298587588",
    "45613301226",
    "17194366678",
    "44448365682",
    "2059015970",
    "44654597503",
    "5923988073",
    "1571056342",
    "6762912768",
    "1938896920",
    "51307021402",
    "29123073107",
    "54153675563",
    "10320989777",
    "1292044376",
    "60316266790",
    "59183665447",
    "48720124420",
    "56798635732",
    "31452800",
    "44566221660",
    "36729733437",
    "72938311377",
    "55527822148",
    "10847340282",
    "27427350193",
    "52676330232",
    "58656316691",
    "56662576653",
    "47229432389",
    "44200374425",
    "61941425839",
    "26825075115",
    "59154260241",
    "46700665711",
    "52051084095",
    "39747881267",
    "56503527508",
    "9299074202",
    "4397702959",
    "6081310161",
    "3656852613",
    "53125363",
    "55354005213",
    "32563888819",
    "51575265426",
    "8327011518",
    "48928198102",
    "2044967924",
    "24004222992",
    "12378346374",
    "39565909372",
    "70666175392",
    "6904685032",
    "8744125484",
    "6250216367",
    "48310808010",
    "53597618034",
    "64780600662",
    "47734613158",
    "12294046086",
    "60904195215",
    "5701454840",
    "701243118",
    "5740075657",
    "43026101327",
    "6101979832",
]


class FeedInjectedReelsMediaHandler(
    CommandHandler[FeedInjectedReelsMedia, FeedInjectedReelsMediaResponse]
):
    def __init__(self, api: ApiRequestExecutor, state: MobileClientState) -> None:
        self.api = api
        self.state = state

    async def __call__(self, command: FeedInjectedReelsMedia) -> FeedInjectedReelsMediaResponse:
        data = {
            "num_items_in_pool": "0",
            "has_camera_permission": "0",
            "is_ad_pod_enabled": "true",
            "is_prefetch": "true",
            "is_self_pog_chaining": "false",
            "is_inventory_based_request_enabled": "true",
            "is_refresh": "false",
            "is_media_based_insertion_enabled": "true",
            "phone_id": self.state.device.phone_id,
            "is_ads_sensitive": "false",
            "entry_point_index": "0",
            "earliest_request_position": "0",
            "ad_request_index": "0",
            "battery_level": self.state.device.battery_level,
            "client_recorded_request_time_ms": str(current_timestamp_ms()),
            "tray_session_id": generate_uuid_v4_string(),
            "_uid": self.state.local_data.user_id,
            "is_carry_over_first_page": "false",
            "_uuid": self.state.device.device_id,
            "client_doc_id": "33469793811500731569328700797",
            "is_charging": "1" if self.state.device.is_charging else "0",
            "is_async_prepare_enabled": "false",
            "reel_position": "0",
            "is_dark_mode": "0",
            "viewer_session_id": generate_uuid_v4_string(),
            "will_sound_on": "0",
            "container_module": "",
            "is_first_page": "true",
            "inserted_ad_indices": [],
            "inserted_netego_indices": [],
            "odml": {"story_prefetch_score": 0.12128931283950806},
            "tray_user_ids": [
                self.state.local_data.user_id,
                *TRAY_USER_IDS,
            ],
            "ad_and_netego_request_information": [],
        }

        signed = build_signed_body(data)
        payload = gzip.compress(signed.encode("utf-8"))

        res = await self.api.call_api(
            method="POST",
            uri=constants.FEED_INJECTED_REELS_MEDIA_URI,
            data=payload,
            client_endpoint="feed_timeline",
            extra_headers={
                "content-encoding": "gzip",
                "x-cm-bandwidth-kbps": "619.744",
                "x-cm-latency": "19.849",
                "x-ig-nav-chain": "MainFeedFragment:feed_timeline:1:cold_start:1755922781.967::",
            },
        )
        return cast(FeedInjectedReelsMediaResponse, res)
